name: Tag Checks
on:
  push:

jobs:
  check:
    name: Acceptance Tests Across Tags
    # Ensure acceptance tests are only run on okta/terraform-provider-oktapam or if a special label is applied (`run-acceptance-tests`)
    if: github.repository == 'okta/terraform-provider-oktapam' || github.event.label.name == 'run-acceptance-tests'
    runs-on: ubuntu-latest
    strategy:
      matrix:
        # On version change, add new version here
        tag: [0, 1, 2, 3, 4]
    steps:
      - name: Check out repository code of tag
        uses: actions/checkout@v3
        with:
          ref: v0.1.${{ matrix.tag }}
      - name: Run unit tests
        run: |
          ./scripts/ci-acceptance-tests.sh
        env:
          OKTAPAM_SECRET: ${{ secrets.OKTA_499446_OKTAPAM_SECRET }}
          OKTAPAM_KEY: ${{ secrets.OKTA_499446_OKTAPAM_KEY }}
          OKTAPAM_TEAM: ${{ secrets.OKTA_499446_OKTAPAM_TEAM }}
          OKTAPAM_API_HOST: ${{ secrets.OKTA_499446_OKTAPAM_API_HOST }}
      - run: echo "üçè This job's status is ${{ job.status }}."
  notify-on-failure:
    name: Notify Slack on Failure
    runs-on: ubuntu-latest
    needs: [check1, check2, check3, check4]
    if: failure() && github.repository == 'okta/terraform-provider-oktapam' && ((github.ref_type == 'branch' && github.ref_name == 'master') || github.ref_type == 'tag')
    steps:
      - name: Check out repository code
        uses: actions/checkout@v2
      - name: Notify Slack
        uses: fjogeleit/http-request-action@v1
        with:
          url: ${{ secrets.OKTA_499446_SLACK_WEBHOOK }}
          method: 'POST'
          customHeaders: '{"Content-Type": "application/json"}'
          data: '{"build_link": "${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}", "branch": "${{ github.ref_name }}" }'